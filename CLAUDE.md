# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A self-hosted VPN stack using Docker Compose. The WireGuard admin panel is protected by Authelia TOTP authentication — there is no built-in password fallback, access requires both a valid Authelia session and TOTP code.

## Installation

Run the master installer on any fresh Linux server (Ubuntu/Debian/AlmaLinux/Rocky/RHEL/Fedora):

```bash
curl -fsSL https://raw.githubusercontent.com/tahasaifeee/vpnstack/main/install.sh | sudo bash
```

The installer interactively asks for: domain, public IP, admin credentials, TOTP on/off, TLS method (Let's Encrypt or self-signed), WireGuard DNS/IPs, and firewall setup. It generates all config files, secrets, and starts the stack automatically under `/opt/vpnstack` (override with `VPNSTACK_DIR=/your/path`).

## Stack Management

All operations go through `scripts/manage.sh` (generated by installer, also symlinked as `vpnstack`):

```bash
vpnstack up                                              # Start full stack
vpnstack status                                          # Health check all services
vpnstack logs [service]                                  # Follow logs
vpnstack add-user <name> <email> <pass> <group>         # Add Authelia user
vpnstack hash-password 'password'                        # Generate Argon2id hash
vpnstack totp-reset <username>                           # Force TOTP re-enrollment
vpnstack backup                                          # Backup volumes + config
vpnstack update                                          # Pull latest images & restart
```

Direct Docker Compose commands also work from `$INSTALL_DIR`:
```bash
docker compose up -d
docker compose down
docker compose logs -f <service>   # traefik, authelia, wg-easy, postgres, redis
```

## Architecture

```
Internet → Traefik (:443) → Authelia forward-auth → wg-easy admin panel
                                                   → WireGuard VPN (:51820/UDP, direct)
```

**Networks:**
- `proxy` — Traefik, wg-easy, Authelia (internet-facing)
- `vpn_internal` — PostgreSQL, Redis (no external access)

**Service roles:**
- **Traefik** — TLS termination, hostname-based routing, enforces Authelia middleware on `vpn.yourdomain.com`
- **Authelia** — Forward-auth provider; TOTP secrets and session metadata in PostgreSQL; session tokens in Redis
- **wg-easy** — WireGuard kernel interface (UDP 51820) + web admin UI (51821, only reachable through Traefik+Authelia)
- **PostgreSQL** — Authelia's persistent store (TOTP secrets, user sessions)
- **Redis** — Authelia session cache (128MB, LRU eviction, password-protected)

## Configuration

All secrets and domain settings live in `.env` (git-ignored). Use `.env.example` as the template. Required variables:

- `DOMAIN` / `VPN_HOST` — your public domain and IP
- `AUTHELIA_JWT_SECRET`, `AUTHELIA_SESSION_SECRET`, `AUTHELIA_STORAGE_ENCRYPTION_KEY` — 64-char hex strings
- `POSTGRES_PASSWORD`, `REDIS_PASSWORD`
- `ACME_EMAIL` — for Let's Encrypt

Authelia user database is at `authelia/users.yml` (created during setup, not tracked in git). Passwords use Argon2id hashing.

## Key Files

| File | Purpose |
|------|---------|
| `install.sh` | Master installer — generates all config, installs Docker, starts stack |
| `docker-compose.yml` | Base service definitions (installer generates a customized copy at runtime) |
| `.gitignore` | Protects `.env`, `traefik/certs/`, `backups/` from being committed |

Files generated by the installer at runtime (not in git):

| Path (under `$INSTALL_DIR`) | Purpose |
|---|---|
| `.env` | All secrets and environment variables |
| `authelia/config/configuration.yml` | Authelia settings (TOTP, session, storage) |
| `authelia/config/users_database.yml` | User accounts with Argon2id hashes |
| `traefik/config/tls.yml` | TLS cipher options and cert paths |
| `traefik/certs/` | Self-signed cert or Let's Encrypt acme.json |
| `scripts/manage.sh` | Management CLI (also symlinked as `/usr/local/bin/vpnstack`) |

## Security Constraints

- Never commit `.env`, `authelia/users.yml`, or anything under `traefik/certs/` or `backups/` — these are git-ignored for a reason.
- The Authelia `STORAGE_ENCRYPTION_KEY` must remain consistent across restarts; changing it corrupts the database.
- WireGuard port 51820/UDP must be open directly in the firewall; it does not go through Traefik.
- Ports 80 and 443 must be open for Traefik (80 redirects to 443).
