###############################################################################
# WireGuard VPN Stack with TOTP Auth
# Components: WireGuard (WGDashboard) + Authelia (TOTP) + Traefik + Redis + Postgres
# GitHub: donaldzou/WGDashboard | authelia/authelia (actively maintained)
# NOTE: This is the reference/base file. The installer (install.sh) generates
#       a customised copy at runtime based on your answers (TLS method, TOTP, etc.)
###############################################################################

version: "3.9"

networks:
  proxy:
    name: proxy
    driver: bridge
  vpn_internal:
    name: vpn_internal
    driver: bridge
    internal: true     # No direct internet access for internal services

volumes:
  wgdashboard_conf:    # WireGuard configs (/etc/wireguard)
  wgdashboard_aconf:   # AmneziaWG configs
  wgdashboard_data:    # WGDashboard app data + SQLite DB
  authelia_db:
  redis_data:

services:

  ##############################################################################
  # TRAEFIK - Reverse Proxy & TLS Termination
  ##############################################################################
  traefik:
    image: traefik:v3.2
    container_name: traefik
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=proxy"
      - "--providers.file.directory=/config"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls=true"
      # Uncomment for Let's Encrypt (requires public domain + open port 80):
      # - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      # - "--certificatesresolvers.letsencrypt.acme.storage=/certs/acme.json"
      # - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/config:/config:ro
      - ./traefik/certs:/certs
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      # Traefik dashboard (protected by Authelia)
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=authelia@docker"
      # Authelia forward-auth middleware definition (reused by all protected services)
      - "traefik.http.middlewares.authelia.forwardauth.address=http://authelia:9091/api/authz/forward-auth"
      - "traefik.http.middlewares.authelia.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia.forwardauth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email"

  ##############################################################################
  # AUTHELIA - Authentication Portal with TOTP
  ##############################################################################
  authelia:
    image: authelia/authelia:4.39
    container_name: authelia
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      - TZ=${TZ:-UTC}
      - AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET}
      - AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET}
      - AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_ENCRYPTION_KEY}
      - AUTHELIA_STORAGE_POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./authelia/config:/config
    networks:
      - proxy
      - vpn_internal
    expose:
      - "9091"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authelia.rule=Host(`auth.${DOMAIN}`)"
      - "traefik.http.routers.authelia.entrypoints=websecure"
      - "traefik.http.services.authelia.loadbalancer.server.port=9091"

  ##############################################################################
  # REDIS - Session storage for Authelia
  ##############################################################################
  redis:
    image: redis:7-alpine
    container_name: authelia-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - vpn_internal
    expose:
      - "6379"

  ##############################################################################
  # POSTGRES - Persistent storage for Authelia (TOTP secrets, user sessions)
  ##############################################################################
  postgres:
    image: postgres:16-alpine
    container_name: authelia-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=authelia
      - POSTGRES_USER=authelia
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - authelia_db:/var/lib/postgresql/data
    networks:
      - vpn_internal
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U authelia"]
      interval: 10s
      timeout: 5s
      retries: 5

  ##############################################################################
  # WGDASHBOARD - WireGuard VPN + Web Admin Panel
  # Admin panel is protected behind Authelia (TOTP at Traefik edge).
  # WGDashboard also has its own login (username/password) — defence in depth.
  # Access flow: vpn.domain.com → Traefik → Authelia (TOTP) → WGDashboard login
  ##############################################################################
  wgdashboard:
    image: ghcr.io/wgdashboard/wgdashboard:latest
    container_name: wgdashboard
    restart: unless-stopped
    depends_on:
      - traefik
      - authelia
    environment:
      - tz=${TZ:-UTC}
      - public_ip=${VPN_HOST}           # Server's public IP shown to WireGuard clients
      - username=${WGD_USERNAME}        # WGDashboard admin username
      - password=${WGD_PASSWORD}        # Plain text — bcrypt-hashed by container on startup
      - wgd_port=10086                  # Internal web UI port
      - wg_port=51820                   # WireGuard UDP port
      - global_dns=${WG_DNS:-1.1.1.1}  # DNS pushed to WireGuard clients
      - out_adapt=${WG_IFACE:-eth0}     # Outbound interface for NAT masquerading
      - wg_autostart=true               # Auto-start wg0 interface on container boot
      - enable_totp=false               # Disabled — Authelia handles TOTP at the edge
    volumes:
      - wgdashboard_conf:/etc/wireguard           # WireGuard configs and keys
      - wgdashboard_aconf:/etc/amnezia/amneziawg  # AmneziaWG configs
      - wgdashboard_data:/data                     # App data, SQLite DB, INI config
    cap_add:
      - NET_ADMIN          # Required for creating/managing WireGuard interfaces
    networks:
      - proxy
    ports:
      - "51820:51820/udp"  # WireGuard tunnel (direct, not proxied through Traefik)
    expose:
      - "10086"            # Web UI — only reachable via Traefik + Authelia
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wgdashboard.rule=Host(`vpn.${DOMAIN}`)"
      - "traefik.http.routers.wgdashboard.entrypoints=websecure"
      - "traefik.http.routers.wgdashboard.middlewares=authelia@docker"   # ← Authelia gate
      - "traefik.http.services.wgdashboard.loadbalancer.server.port=10086"
