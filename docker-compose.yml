###############################################################################
# WireGuard VPN Stack with TOTP Auth
# Components: WireGuard (wg-easy) + Authelia (TOTP) + Traefik + Redis + Postgres
# GitHub: wg-easy/wg-easy (⭐24.7k) | authelia/authelia (actively maintained)
###############################################################################

version: "3.9"

networks:
  proxy:
    name: proxy
    driver: bridge
  vpn_internal:
    name: vpn_internal
    driver: bridge
    internal: true     # No direct internet access for internal services

volumes:
  wg_data:
  authelia_db:
  redis_data:

services:

  ##############################################################################
  # TRAEFIK - Reverse Proxy & TLS Termination
  ##############################################################################
  traefik:
    image: traefik:v3.2
    container_name: traefik
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=proxy"
      - "--providers.file.directory=/config"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls=true"
      # Uncomment for Let's Encrypt (requires public domain):
      # - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      # - "--certificatesresolvers.letsencrypt.acme.storage=/certs/acme.json"
      # - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "443:443"
      # WireGuard UDP port (not routed through Traefik, directly mapped)
      - "51820:51820/udp"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/config:/config:ro
      - ./traefik/certs:/certs
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      # Traefik dashboard (protected by Authelia)
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=authelia@docker"
      # Authelia forward-auth middleware definition (used by all services)
      - "traefik.http.middlewares.authelia.forwardauth.address=http://authelia:9091/api/authz/forward-auth"
      - "traefik.http.middlewares.authelia.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia.forwardauth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email"

  ##############################################################################
  # AUTHELIA - Authentication Portal with TOTP
  ##############################################################################
  authelia:
    image: authelia/authelia:4.39
    container_name: authelia
    restart: unless-stopped
    depends_on:
      - redis
      - postgres
    environment:
      - TZ=${TZ:-UTC}
      # Secrets via env (alternatively use Docker secrets)
      - AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET}
      - AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET}
      - AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_ENCRYPTION_KEY}
      - AUTHELIA_STORAGE_POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./authelia/config:/config
    networks:
      - proxy
      - vpn_internal
    expose:
      - "9091"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authelia.rule=Host(`auth.${DOMAIN}`)"
      - "traefik.http.routers.authelia.entrypoints=websecure"
      - "traefik.http.services.authelia.loadbalancer.server.port=9091"

  ##############################################################################
  # REDIS - Session storage for Authelia
  ##############################################################################
  redis:
    image: redis:7-alpine
    container_name: authelia-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - vpn_internal
    expose:
      - "6379"

  ##############################################################################
  # POSTGRES - Persistent storage for Authelia (TOTP secrets, user sessions)
  ##############################################################################
  postgres:
    image: postgres:16-alpine
    container_name: authelia-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=authelia
      - POSTGRES_USER=authelia
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - authelia_db:/var/lib/postgresql/data
    networks:
      - vpn_internal
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U authelia"]
      interval: 10s
      timeout: 5s
      retries: 5

  ##############################################################################
  # WG-EASY - WireGuard VPN + Admin Panel
  # Admin panel is protected behind Authelia (TOTP required to access)
  ##############################################################################
  wg-easy:
    image: ghcr.io/wg-easy/wg-easy:15
    container_name: wg-easy
    restart: unless-stopped
    depends_on:
      - traefik
      - authelia
    environment:
      - LANG=en
      - WG_HOST=${VPN_HOST}           # Your server's public IP or domain
      - WG_PORT=51820                 # WireGuard UDP port
      - PORT=51821                    # Web UI port (internal)
      - WG_DEFAULT_DNS=${WG_DNS:-1.1.1.1}
      - WG_ALLOWED_IPS=${WG_ALLOWED_IPS:-0.0.0.0/0}
      - WG_DEFAULT_ADDRESS=10.8.0.x
      - WG_PERSISTENT_KEEPALIVE=25
      - UI_TRAFFIC_STATS=true
      - UI_CHART_TYPE=1               # 0=none, 1=line, 2=area, 3=bar
      # NOTE: wg-easy's built-in password is DISABLED here
      # Access is controlled entirely by Authelia TOTP
      - INSECURE=false
    volumes:
      - wg_data:/etc/wireguard
      - /lib/modules:/lib/modules:ro
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1
    networks:
      - proxy
    ports:
      - "51820:51820/udp"             # WireGuard tunnel port (direct, no proxy)
    expose:
      - "51821"                       # Web UI only via Traefik+Authelia
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wg-easy.rule=Host(`vpn.${DOMAIN}`)"
      - "traefik.http.routers.wg-easy.entrypoints=websecure"
      - "traefik.http.routers.wg-easy.middlewares=authelia@docker"   # ← TOTP enforced here
      - "traefik.http.services.wg-easy.loadbalancer.server.port=51821"
